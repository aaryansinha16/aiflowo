# Database Schema Documentation

## Overview

This document describes the database schema for AI Flowo, organized by feature area.

## Models

### üìß Authentication & Users

#### `User`
Core user table for authentication.

| Field | Type | Description |
|-------|------|-------------|
| id | String (cuid) | Unique identifier |
| email | String | User email (unique) |
| createdAt | DateTime | Account creation date |
| updatedAt | DateTime | Last update |

**Relations:**
- `profile` ‚Üí UserProfile (1:1)
- `tasks` ‚Üí Task[] (1:Many)
- `magicLinks` ‚Üí MagicLink[] (1:Many)
- `sessions` ‚Üí Session[] (1:Many)

---

#### `UserProfile`
Extended user information and preferences.

| Field | Type | Description |
|-------|------|-------------|
| id | String (cuid) | Unique identifier |
| userId | String | Reference to User |
| name | String? | User's full name |
| profilePicUrl | String? | Profile picture URL |
| **Travel Preferences** |
| preferredAirlines | String[] | Preferred airlines list |
| preferredCabinClass | String? | economy/business/first |
| frequentFlyerNumbers | Json? | Airline loyalty numbers |
| **Social Media** |
| socialAccounts | Json? | Connected social accounts |
| **Professional** |
| resumeUrl | String? | Resume/CV URL |
| linkedInUrl | String? | LinkedIn profile |
| githubUrl | String? | GitHub profile |
| portfolioUrl | String? | Portfolio website |
| **Settings** |
| timezone | String | User timezone (default: UTC) |
| notifications | Boolean | Email notifications enabled |

---

#### `MagicLink`
Passwordless authentication tokens.

| Field | Type | Description |
|-------|------|-------------|
| id | String (cuid) | Unique identifier |
| token | String | Unique magic link token |
| userId | String | Reference to User |
| email | String | Email address |
| expiresAt | DateTime | Token expiration |
| used | Boolean | Whether token was used |
| usedAt | DateTime? | When token was used |

---

#### `Session`
Active user sessions.

| Field | Type | Description |
|-------|------|-------------|
| id | String (cuid) | Unique identifier |
| userId | String | Reference to User |
| token | String | Session token |
| expiresAt | DateTime | Session expiration |

---

### ‚öôÔ∏è Task Execution

#### `Task`
Main task execution records.

| Field | Type | Description |
|-------|------|-------------|
| id | String (cuid) | Unique identifier |
| userId | String | Task owner |
| title | String | Task title |
| description | String? | Detailed description |
| intent | String | Original user request |
| status | TaskStatus | Current status |
| priority | TaskPriority | Task priority |
| **Execution Plan** |
| plan | Json? | LLM-generated execution plan |
| currentStep | Int | Current execution step |
| totalSteps | Int | Total number of steps |
| **Results** |
| result | Json? | Task execution result |
| error | String? | Error message if failed |
| **Timing** |
| startedAt | DateTime? | Execution start time |
| completedAt | DateTime? | Execution end time |

**Enums:**
- `TaskStatus`: PENDING, RUNNING, PAUSED, SUCCEEDED, FAILED, CANCELLED
- `TaskPriority`: LOW, MEDIUM, HIGH, URGENT

**Relations:**
- `logs` ‚Üí TaskLog[] (1:Many)
- `artifacts` ‚Üí TaskArtifact[] (1:Many)

---

#### `TaskLog`
Execution logs and traces.

| Field | Type | Description |
|-------|------|-------------|
| id | String (cuid) | Unique identifier |
| taskId | String | Reference to Task |
| level | LogLevel | Log level |
| message | String (Text) | Log message |
| step | Int? | Step number |
| metadata | Json? | Additional context |
| timestamp | DateTime | Log timestamp |

**Enums:**
- `LogLevel`: DEBUG, INFO, WARN, ERROR

---

#### `TaskArtifact`
Files and media generated by tasks.

| Field | Type | Description |
|-------|------|-------------|
| id | String (cuid) | Unique identifier |
| taskId | String | Reference to Task |
| type | ArtifactType | Artifact type |
| name | String | File name |
| description | String? | Description |
| url | String | S3 URL or path |
| size | Int? | File size (bytes) |
| mimeType | String? | MIME type |

**Enums:**
- `ArtifactType`: SCREENSHOT, PDF, FILE, IMAGE, VIDEO, JSON, TEXT

---

### üõ†Ô∏è Tools & Agent

#### `Tool`
Available tools registry.

| Field | Type | Description |
|-------|------|-------------|
| id | String (cuid) | Unique identifier |
| name | String | Tool identifier (unique) |
| displayName | String | Human-readable name |
| description | String (Text) | Tool description |
| category | ToolCategory | Tool category |
| schema | Json | JSON Schema for params |
| enabled | Boolean | Tool availability |
| usageCount | Int | Total usage count |

**Enums:**
- `ToolCategory`: BROWSER, API, FILE, EMAIL, SOCIAL, TRAVEL, JOB, GENERAL

**Relations:**
- `executions` ‚Üí ToolExecution[] (1:Many)

---

#### `ToolExecution`
Individual tool execution records.

| Field | Type | Description |
|-------|------|-------------|
| id | String (cuid) | Unique identifier |
| toolId | String | Reference to Tool |
| taskId | String? | Optional Task reference |
| input | Json | Tool input parameters |
| output | Json? | Tool output result |
| error | String? | Error message |
| status | ExecutionStatus | Execution status |
| duration | Int? | Duration (milliseconds) |
| startedAt | DateTime? | Start time |
| completedAt | DateTime? | End time |

**Enums:**
- `ExecutionStatus`: PENDING, RUNNING, COMPLETED, FAILED

---

### üì¨ Queue Management

#### `QueueJob`
Background job tracking.

| Field | Type | Description |
|-------|------|-------------|
| id | String (cuid) | Unique identifier |
| queue | QueueName | Queue name |
| jobId | String | BullMQ job ID (unique) |
| taskId | String? | Optional Task reference |
| data | Json | Job payload |
| status | String | Job status |
| progress | Int | Progress percentage |
| attempts | Int | Retry attempts |
| maxAttempts | Int | Max retry limit |
| error | String? | Error message |
| result | Json? | Job result |
| createdAt | DateTime | Created timestamp |
| startedAt | DateTime? | Start timestamp |
| completedAt | DateTime? | Completion timestamp |
| failedAt | DateTime? | Failure timestamp |

**Enums:**
- `QueueName`: TASK, BROWSER, MEDIA, EMAIL

---

## Indexes

Performance-optimized indexes:

- **User**: `email`
- **UserProfile**: `userId`
- **MagicLink**: `token`, `userId`, `email`
- **Session**: `token`, `userId`
- **Task**: `userId`, `status`, `createdAt`
- **TaskLog**: `taskId`, `timestamp`
- **TaskArtifact**: `taskId`
- **Tool**: `category`, `enabled`
- **ToolExecution**: `toolId`, `taskId`, `status`, `createdAt`
- **QueueJob**: `queue`, `jobId`, `taskId`, `status`

---

## Relationships Diagram

```
User
‚îú‚îÄ‚îÄ UserProfile (1:1)
‚îú‚îÄ‚îÄ Task (1:Many)
‚îÇ   ‚îú‚îÄ‚îÄ TaskLog (1:Many)
‚îÇ   ‚îî‚îÄ‚îÄ TaskArtifact (1:Many)
‚îú‚îÄ‚îÄ MagicLink (1:Many)
‚îî‚îÄ‚îÄ Session (1:Many)

Tool
‚îî‚îÄ‚îÄ ToolExecution (1:Many)
    ‚îî‚îÄ‚îÄ Task? (Optional Link)

QueueJob
‚îî‚îÄ‚îÄ Task? (Optional Link)
```

---

## Migration Commands

```bash
# Generate Prisma Client
npm run prisma:generate

# Create migration
npm run prisma:migrate

# Apply migration (production)
npm run prisma:migrate:prod

# Seed database
npm run prisma:seed

# Open Prisma Studio
npm run prisma:studio

# Reset database (dev only)
npm run prisma:reset
```

---

## Seeding

The seed file creates:
- 12 predefined tools (search_google, navigate_url, take_screenshot, etc.)
- Tool categories: Browser, Email, Travel, Social, Job, File

Run seeding:
```bash
npm run prisma:seed
```

---

## Environment Variables

Required in `.env`:
```bash
DATABASE_URL="postgresql://user:password@localhost:5432/aiflowo?schema=public"
```

---

## Best Practices

1. **Always use transactions** for multi-model operations
2. **Use select/include** to optimize queries
3. **Add indexes** for frequently queried fields
4. **Use soft deletes** for important data (add `deletedAt` field)
5. **Version your migrations** with meaningful names
